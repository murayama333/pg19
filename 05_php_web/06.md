# データベース

+ PHPからデータベースにアクセスできる
+ PDOという仕組みによってデータベース製品に依存しないプログラムを作成できる
+ `new`キーワードによってPDOインスタンスを作成する


### 01.sql

+ 以下のSQLを実行してテストデータを準備する

```sql
create database my_company;
use my_company;

create table department(
  id int primary key,
  name varchar(100)
);

insert into department(id, name) values(1, 'Development');
insert into department(id, name) values(2, 'Sales');
insert into department(id, name) values(3, 'Accounting');
insert into department(id, name) values(4, 'Legal');
```

### db1.php

+ PDOクラスのコンストラクタに3つの引数（DSN、ユーザ名、パスワード）を指定して、PDOインスタンスを生成する
+ PDOインスタンス(`$pdo`)の`query`メソッドの引数にSQL文字列を指定する
+ PDOインスタンス(`$pdo`)の`fetchAll`メソッドを呼び出すとSQLの実行結果すべてを配列で取得できる

```php
<?php
$dsn = "mysql:host=localhost;dbname=my_company";
$user = "root";
$pass = "admin";
$pdo = new PDO($dsn, $user, $pass);

$sql = "select id, name from department";
$st = $pdo->query($sql);
$rows = $st->fetchAll();
foreach ($rows as $row) {
  echo $row["id"] . ":" . $row["name"] .  PHP_EOL;
}
```

#### 実行

```
> php db1.php
1:Development
2:Sales
3:Accounting
4:Legal
```

---

### db2.php

+ PDOインスタンス(`$pdo`)の`fetch`メソッドを呼び出すとSQLの実行結果から1行のデータを配列で取得できる

```php
<?php
$dsn = "mysql:host=localhost;dbname=my_company";
$user = "root";
$pass = "admin";
$pdo = new PDO($dsn, $user, $pass);

$sql = "select id, name from department";
$st = $pdo->query($sql);
while ($row = $st->fetch()) {
  echo $row["id"] . ":" . $row["name"] .  PHP_EOL;
}
```

#### 実行

```
> php db2.php
1:Development
2:Sales
3:Accounting
4:Legal
```

---

### db3.php

+ PDOインスタンス(`$pdo`)の`exec`メソッドを呼び出すとINSERT文やUPDATE文、DELETE文を実行できる

```php
<?php
$pdo = new PDO('mysql:host=localhost;dbname=my_company', 'root', 'admin');
$sql = "insert into department(id, name) values(5, 'Human Resources')";
$count = $pdo->exec($sql);
echo $count . PHP_EOL;
```

> + PDOインスタンス(`$pdo`)の`exec`メソッドは戻り値に更新件数を返します。


#### 実行

```
> php db3.php
1
```

---

### 02.sql

+ 以下のSQLを実行してテストデータを準備する

```sql
delete from department;
```

### db4.php

+ Prepared Statementsによって構文解析とパラメータ設定を分離できるため、類似したSQLを高速に実行できる
+ PDOインスタンス(`$pdo`)の`prepare`メソッドを呼び出すことでPrepared Statementsを利用できる
+ PDOStatementインスタンス(`$ps`)の`bindValue`メソッドを呼び出すことでパラメータを設定できる

```php
<?php
$departments = [
  ["id" => 1, "name" => "Development"],
  ["id" => 2, "name" => "Sales"],
  ["id" => 3, "name" => "Accounting"],
  ["id" => 4, "name" => "Legal"],
];

$pdo = new PDO('mysql:host=localhost;dbname=my_company', 'root', 'admin');

$sql = "insert into department(id, name) values(?, ?)";
$ps = $pdo->prepare($sql);
foreach ($departments as $department) {
  $ps->bindValue(1, $department["id"]);
  $ps->bindValue(2, $department["name"]);
  $ps->execute();
}
```

>

#### 実行

```
> php db4.php
```

> 実行結果は何も表示されません。MySQLに接続してdepartmentテーブルを検索してください。

---

### 演習

+ [エクササイズ - セッション](ex/06_ex.md)
